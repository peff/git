#!/usr/bin/perl

my %local = (
	map { split / +/, $_, 2 }
	map { chomp; $_ }
	`Meta/topics --format='%(refname:short) %(objectname)'`
);
my %remote = (
	map { split / /, $_, 2 }
	grep { m{/} }
	map { s,^github/,,; $_ }
	map { chomp; $_ }
	`git for-each-ref --format='%(refname:short) %(objectname)' refs/remotes/github`
);

if (grep { $_ eq "--unmatched" } @ARGV) {
	print "$_\n" for
		grep { $remote{$_} && $remote{$_} ne $local{$_} }
		(sort keys(%local));
	exit 0;
}

my @push = grep { !$remote{$_} } (sort keys(%local));
my @prune = grep { !$local{$_} } (sort keys(%remote));

if (grep { $_ eq "--stale" } @ARGV) {
	print "PUSH:$_\n" foreach @push;
	print "PRUNE:$_\n" foreach @prune;
	exit 0;
}
elsif (grep { $_ eq "--push" } @ARGV) {
	print "$_\n" for @push;
	print ":$_\n" for @prune;
	exit 0;
}

if (@push) {
	print "Local branches that need pushed:\n";
	print $_, "\n" foreach @push;
}
if (@prune) {
	print "\n" if @push;
	print "Remote branches that need pruned:\n";
	print $_, "\n" foreach @prune;
}
