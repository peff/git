#!/bin/sh

export GIT_META_TEST
if test -z "$GIT_META_TEST"; then
	GIT_META_TEST='git test run HEAD'
fi

while test $# -gt 0; do
	case "$1" in
	-c) GIT_META_TEST='git test run -t compile' ;;
	-t) GIT_META_TEST="make -j8 && (cd t && ./t${2#t}-*.sh)"; shift ;;
	--retest) GIT_META_TEST='git test run --retest HEAD' ;;
	*) break ;;
	esac
	shift
done

if test $# -lt 1; then
  upstream=`git rev-parse --symbolic-full-name @{u} 2>/dev/null`
  set -- ${upstream:-origin}
fi
GIT_EDITOR='sed -i "/^pick .*/aexec $GIT_META_TEST"' \
	git rebase -i "$@"
